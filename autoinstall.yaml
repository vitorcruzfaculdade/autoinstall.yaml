#cloud-config
autoinstall:
  version: 1
  locale: pt_BR.UTF-8
  keyboard:
    layout: br
  identity:
    hostname: ubuntu-desktop
    username: administrador
    password: "$6$u9w11mcDgLFTY1k0$jKePXcb6Etztl08oakzYFk6Wve3dOkVW1bFeNrKfddDSMs6bOJMu7lgpImWfzkTSmwB7hQM8LQPCEMWDPWAA71"
  timezone: America/Sao_Paulo
  storage:
    layout:
      name: direct
    erase: true
    use-lvm: false
  packages:
    - flatpak
    - snapd
    - gnome-software
    - gnome-software-plugin-flatpak
    - gnome-software-plugin-snap
    - apt-transport-https
    - software-properties-common
    - curl
    - wget
    - preload
    - zram-tools 
    - ufw
    - gufw
    - openssh-server
    - language-selector-common
    - language-pack-pt
    - language-pack-pt-base
    - language-pack-gnome-pt
    - language-pack-gnome-pt-base
    - libreoffice
    - libreoffice-l10n-pt-br
    - libreoffice-l10n-pt
    - libreoffice-help-pt-br
    - libreoffice-help-pt
    - hunspell-pt-br
    - hunspell-pt-pt
    - hyphen-pt-br
    - hyphen-pt-pt
    - mythes-pt-br
    - mythes-pt-pt
    - aspell-pt-br
    - ttf-mscorefonts-installer
    - fonts-crosextra-carlito
    - fonts-crosextra-caladea
    - fonts-liberation
    - fonts-noto
    - fonts-noto-color-emoji
    - fonts-dejavu
    - fonts-freefont-ttf
    - fonts-noto-mono
    - fonts-noto-ui-core
    - thunderbird
    - thunderbird-locale-pt-br
    - thunderbird-locale-pt
    - thunderbird-locale-pt-pt
    - gzip
    - bzip2
    - xz-utils
    - tar
    - arc
    - lzop
    - cpio
    - lzma
    - p7zip-full
    - 7zip-rar
    - zip
    - unzip
    - rar
    - unrar
    - ubuntu-restricted-extras
    - ubuntu-restricted-addons
    - gstreamer1.0-plugins-good
    - gstreamer1.0-plugins-bad
    - gstreamer1.0-plugins-ugly
    - gstreamer1.0-libav
    - totem
    - totem-common
    - totem-plugins
    - dconf-cli
    - gnome-extensions-app
    - mesa-utils
    - mesa-vulkan-drivers
    - vulkan-tools
  snaps:
    - name: firefox
    - name: thunderbird
    - name: gnome-weather
    - name: onlyoffice-desktopeditors
  late-commands:
    - curtin in-target -- bash -c "echo 'LANG=pt_BR.UTF-8' > /etc/default/locale"
    - curtin in-target -- apt update && apt full-upgrade -y
    - curtin in-target -- snap refresh
    - curtin in-target -- ubuntu-drivers install
    - curtin in-target -- apt purge -y ubuntu-report popularity-contest apport apport-symptoms whoopsie kerneloops kerneloops-applet || true
    - curtin in-target -- apt autoremove -y
    - curtin in-target -- systemctl stop apport.service || true
    - curtin in-target -- systemctl disable apport.service || true
    - curtin in-target -- systemctl stop whoopsie.service || true
    - curtin in-target -- systemctl disable whoopsie.service || true
    - curtin in-target -- systemctl stop ModemManager.service || true
    - curtin in-target -- systemctl disable ModemManager.service || true
    - curtin in-target -- rm -rf /etc/ubuntu-report
    - curtin in-target -- rm -rf /var/lib/ubuntu-report
    - curtin in-target -- ufw default deny incoming
    - curtin in-target -- ufw default allow outgoing
    - curtin in-target -- ufw allow ssh
    - curtin in-target -- ufw allow 3389/tcp
    - curtin in-target -- ufw allow 3389/udp
    - curtin in-target -- ufw logging on
    - curtin in-target -- ufw --force enable
    - curtin in-target -- apt purge -y vino xrdp vnc4server tightvncserver remmina* modemmanager || true
    - curtin in-target -- flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
    - curtin in-target -- bash -c 'wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | apt-key add -'
    - curtin in-target -- bash -c 'echo "deb [arch=amd64] https://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list'
    - curtin in-target -- apt-get update
    - curtin in-target -- apt-get install -y google-chrome-stable
    - curtin in-target -- sysctl -w fs.suid_dumpable=0
    - curtin in-target -- systemctl enable preload
    - curtin in-target -- systemctl enable zramswap.service || true
    - curtin in-target -- snap remove snap-store || true
    - curtin in-target -- bash -c 'cat <<EOF > /etc/profile.d/99-gnome-settings.sh
#!/bin/bash

if [ -n "\$XDG_CURRENT_DESKTOP" ] && [ "\$XDG_CURRENT_DESKTOP" = "GNOME" ] && [ -n "\$DBUS_SESSION_BUS_ADDRESS" ]; then
  dconf write /org/gnome/shell/extensions/dash-to-dock/dock-position "\"BOTTOM\""
  dconf write /org/gnome/shell/extensions/dash-to-dock/dash-to-dock-alignment "\"center\""
  dconf write /org/gnome/shell/extensions/dash-to-dock/panel-mode false
  dconf write /org/gnome/shell/extensions/dash-to-dock/extend-height true
  dconf write /org/gnome/shell/extensions/dash-to-dock/autohide false
  dconf write /org/gnome/shell/extensions/dash-to-dock/dash-max-icon-size 32
  dconf write /org/gnome/shell/extensions/ding/show-home true
  dconf write /org/gnome/shell/extensions/ding/show-trash true
  dconf write /org/gnome/shell/extensions/ding/show-mount true
  dconf write /org/gnome/shell/extensions/ding/show-volumes true
  dconf write /org/gnome/shell/extensions/ding/show-link-emblem false
fi
EOF'
    - curtin in-target -- chmod +x /etc/profile.d/99-gnome-settings.sh
